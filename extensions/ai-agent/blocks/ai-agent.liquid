<div id="chatbot-container" style="margin: 20px 0;">
  <div id="chatbot-messages" ></div>
  <button id="chatbot-button" style="margin-top: 10px; padding: 10px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 5px;">
    Suggest an Upsell
  </button>
</div>
{% comment %} <script>

  const button = document.getElementById('chatbot-button');
  const messages = document.getElementById('chatbot-messages');

  button.addEventListener('click', async () => {
    button.disabled = true;
    button.textContent = 'Thinking...';

    try {
      const cart = await fetch('/cart.js').then(res => res.json());
      console.log(cart.items, 'cartt')


      const response = await fetch('/apps/upsell', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          "Access-Control-Allow-Origin": "*",
          },
        body: JSON.stringify({
           cartItems: cart.items,
         }),
      });

      const data = await response.json();
      console.log(data, 'dataii')
      const msg = document.createElement('p');
      msg.textContent = data.suggestion;
      messages.appendChild(msg);
    } catch (err) {
      console.error('Error:', err);
      alert('Something went wrong. Try again.');
    } finally {
      button.disabled = false;
      button.textContent = 'Suggest an Upsell';
    }
  });
</script> {% endcomment %}

<script>
  const button = document.getElementById('chatbot-button');
const messages = document.getElementById('chatbot-messages');
const textContainer = document.getElementById('chatbot-text');

async function fetchUpsellSuggestion() {
  try {
    const cart = await fetch('/cart.js').then(res => res.json());
    const response = await fetch('/apps/upsell', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        "Access-Control-Allow-Origin": "*",
      },
      body: JSON.stringify({
        cartItems: cart.items,
      }),
    });

    const data = await response.json();
    console.log(data, 'upsell response');
    showChatbotModal(data.suggestion);
  } catch (err) {
    console.error('Upsell API error:', err);
    showChatbotModal("Something went wrong. Please try again.");
  }
}

// Button-triggered manual upsell request
button.addEventListener('click', async () => {
  button.disabled = true;
  button.textContent = 'Thinking...';

  await fetchUpsellSuggestion();

  button.disabled = false;
  button.textContent = 'Suggest an Upsell';
});



if (typeof Shopify !== 'undefined' && Shopify.onItemAdded) {
  const oldCallback = Shopify.onItemAdded;
  Shopify.onItemAdded = function (line_item) {
    console.log('[Add to Cart] Shopify AJAX item added');
    fetchCartAndTriggerUpsell();
    if (typeof oldCallback === 'function') oldCallback(line_item);
  };
}



// Auto-trigger upsell on add-to-cart events
document.body.addEventListener('click', function (e) {
  const btn = e.target.closest('button, a, input');
  if (btn && JSON.stringify(btn).includes('/cart/add')) {
    console.log('[Add to Cart] AJAX-style button click detected');
    setTimeout(fetchCartAndTriggerUpsell, 1000);
  }
});


document.body.addEventListener('submit', function (e) {
  const form = e.target;
  if (form.matches('form[action*="/cart/add"]')) {
    console.log('[Add to Cart] Form submission detected');
    setTimeout(fetchCartAndTriggerUpsell, 1000);
  }
});


</script>

{% schema %}
  {
    "name": "AI Agent",
    "target": "section",
    "class": "chatbot-section",
    "settings": []
  }
  {% endschema %}


